<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profile ‚Ä¢ Time Nest</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
            rel="stylesheet"
        />
    <link rel="stylesheet" href="./css/style.css" />
</head>

<body class="profile-page">
    <header>
        <h1>Time Nest</h1>
        <button id="hamburger-menu" title="Toggle menu">‚ò∞</button>
        <nav id="navbar">
            <a href="./dashboard.html">Dashboard</a>
            <a href="./tasks.html">Tasks</a>
            <a href="./focus.html">Tools</a>
            <a href="./profile.html" class="active-nav-link">Profile</a>
            <button id="theme-toggle" title="Toggle theme">üåô</button>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </nav>
    </header>

    <main>
        <!-- Profile Header -->
        <section class="profile-header">
            <div class="profile-avatar-container">
                <div class="profile-avatar-large" id="profile-avatar-display">
                    <span id="profile-avatar">U</span>
                </div>
                <label class="avatar-upload" title="Upload Profile Picture">
                    <input type="file" id="avatar-input" accept="image/*">
                    üì∑
                </label>
            </div>
            <div class="profile-name" id="profile-name">User Name</div>
            <div class="profile-email" id="profile-email">user@example.com</div>
            <div class="profile-status" id="profile-status">New member</div>
            <button class="profile-edit-btn" id="edit-profile-btn">‚úèÔ∏è Edit Profile</button>
        </section>

        <!-- Edit Profile Section -->
        <section class="edit-profile-section" id="edit-profile-section">
            <h2>‚úèÔ∏è Edit Profile</h2>
            <form id="edit-profile-form">
                <div class="form-group">
                    <label for="edit-name">Display Name</label>
                    <input type="text" id="edit-name" placeholder="Enter your name" required>
                </div>
                <div class="form-group">
                    <label for="edit-email">Email</label>
                    <input type="email" id="edit-email" placeholder="Enter your email" readonly>
                </div>
                <div class="form-group">
                    <label for="edit-username">Username</label>
                    <input type="text" id="edit-username" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label for="edit-goal">Daily Focus Goal (minutes)</label>
                    <input type="number" id="edit-goal" min="0" step="15" placeholder="e.g. 60">
                </div>
                <div class="form-group">
                    <label for="edit-work-type">Work Type</label>
                    <select id="edit-work-type">
                        <option value="">Select...</option>
                        <option value="student">Student</option>
                        <option value="developer">Developer</option>
                        <option value="professional">Professional</option>
                        <option value="freelancer">Freelancer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-focus-method">Preferred Focus Method</label>
                    <select id="edit-focus-method">
                        <option value="">Select...</option>
                        <option value="pomodoro">Pomodoro</option>
                        <option value="deep-focus">Deep Focus</option>
                        <option value="break-reminders">Break Reminders</option>
                        <option value="ambient">Ambient Sounds</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save Changes</button>
                    <button type="button" class="btn-cancel" id="cancel-edit-btn">Cancel</button>
                </div>
            </form>
        </section>

        <!-- Statistics & Gamification -->
        <section class="grid section-grid-spaced">
            <div>
                <h2 class="mb-1-5">Productivity Stats</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Total Tasks</div>
                        <div class="stat-value" id="stat-tasks">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Completed</div>
                        <div class="stat-value" id="stat-completed">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">In Progress</div>
                        <div class="stat-value" id="stat-pending">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value" id="stat-rate">0%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Weekly Focus Time</div>
                        <div class="stat-value" id="stat-weekly-focus">0h</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Streak</div>
                        <div class="stat-value" id="stat-streak">0 days</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Productivity Score</div>
                        <div class="stat-value" id="stat-score">0</div>
                    </div>
                </div>
            </div>
            <div>
                <h2 class="mb-1-5">Badges &amp; Achievements</h2>
                <p class="muted badge-helper">Complete tasks and focus sessions to unlock badges.</p>
                <div id="badge-container" class="stats-grid-compact badges-grid"></div>
            </div>
        </section>

        <!-- Work History -->
        <section class="history-section">
            <h2 class="mb-1-5">Work History</h2>
            <div id="history-container">
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <p>No work history yet. Start by creating tasks!</p>
                    <p class="muted">Your activity will appear here once you start working.</p>
                </div>
            </div>
        </section>

        <!-- Reminder Settings -->
        <section class="reminder-settings-section">
            <div class="card reminder-card">
                <h2 class="mb-1">Reminder Settings</h2>
                <p class="muted mb-1">TimeNest can gently nudge you when tasks with a due <strong>date &amp; time</strong> are coming up.</p>

                <div class="reminder-row">
                    <div class="reminder-option">
                        <div class="reminder-icon" aria-hidden="true">üîä</div>
                        <div>
                            <div class="reminder-label">Voice reminders</div>
                            <p class="muted small-label">Spoken alert when a task reaches its due time.</p>
                            <p class="muted tiny-helper">Helpful for accessibility and for people who like an extra nudge. Works only for tasks with a due date &amp; time.</p>
                        </div>
                    </div>
                    <label class="reminder-toggle">
                        <input type="checkbox" id="reminder-voice-toggle" />
                        <span class="reminder-toggle-slider" aria-hidden="true"></span>
                    </label>
                </div>

                <div class="reminder-row">
                    <div class="reminder-option">
                        <div class="reminder-icon" aria-hidden="true">üîî</div>
                        <div>
                            <div class="reminder-label">Browser notifications</div>
                            <p class="muted small-label">System notifications 15 minutes before, 5 minutes before, and at the due time.</p>
                        </div>
                    </div>
                    <label class="reminder-toggle">
                        <input type="checkbox" id="reminder-notification-toggle" />
                        <span class="reminder-toggle-slider" aria-hidden="true"></span>
                    </label>
                </div>

                <div class="reminder-divider"></div>

                <p id="reminder-status" class="muted small-label mt-1"></p>

                <div class="reminder-test-row">
                    <button type="button" id="reminder-test-btn" class="secondary reminder-test-btn">
                        ‚è∞ Test Reminder
                    </button>
                </div>
            </div>
        </section>

    <script src="./js/theme.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/reminders.js"></script>
    <script>
        // Hamburger menu toggle
        const hamburger = document.getElementById('hamburger-menu');
        const navbar = document.getElementById('navbar');
        if (hamburger) {
            hamburger.addEventListener('click', () => {
                navbar.classList.toggle('active');
            });

            navbar.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    navbar.classList.remove('active');
                });
            });
        }

        // Logout button functionality
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                window.TimeNestAuth.logout();
                window.location.href = './login.html';
            });
        }

        const FOCUS_STORAGE_KEY = 'timenest_focus_tools_v1';
        const BADGES_STORAGE_KEY = 'timenest_badges_v1';

        const BADGES_CONFIG = [
            {
                id: 'getting-started',
                icon: 'üèÅ',
                title: 'Getting Started',
                description: 'Create your first task.',
                lockedText: 'Locked',
                unlockedText: 'Unlocked by creating a task.',
            },
            {
                id: 'consistency',
                icon: 'üî•',
                title: 'Consistency',
                description: 'Build a 3-day focus streak.',
                lockedText: 'Locked',
                unlockedText: 'Unlocked with a 3-day streak.',
            },
            {
                id: 'task-finisher',
                icon: '‚úÖ',
                title: 'Task Finisher',
                description: 'Complete 10 tasks.',
                lockedText: 'Locked',
                unlockedText: 'Unlocked by completing 10 tasks.',
            },
        ];

        function loadFocusState() {
            try {
                return JSON.parse(localStorage.getItem(FOCUS_STORAGE_KEY)) || { tools: {}, history: {} };
            } catch {
                return { tools: {}, history: {} };
            }
        }

        function todayKey() {
            return new Date().toISOString().slice(0, 10);
        }

        function getStreakDays(state) {
            const keys = Object.keys(state.history || {}).sort();
            if (!keys.length) return 0;
            let streak = 0;
            let current = new Date(todayKey());
            while (true) {
                const key = current.toISOString().slice(0, 10);
                const minutes = state.history[key]?.totalMinutes || 0;
                if (minutes >= 25) {
                    streak += 1;
                    current.setDate(current.getDate() - 1);
                } else {
                    break;
                }
            }
            return streak;
        }

        function getWeeklyFocusHours(state) {
            let totalMinutes = 0;
            const base = new Date(todayKey());
            for (let i = 0; i < 7; i++) {
                const d = new Date(base);
                d.setDate(base.getDate() - i);
                const key = d.toISOString().slice(0, 10);
                totalMinutes += state.history[key]?.totalMinutes || 0;
            }
            return totalMinutes / 60;
        }

        function loadBadgesState() {
            try {
                return JSON.parse(localStorage.getItem(BADGES_STORAGE_KEY)) || { badges: {} };
            } catch {
                return { badges: {} };
            }
        }

        function saveBadgesState(state) {
            localStorage.setItem(BADGES_STORAGE_KEY, JSON.stringify(state));
        }

        function computeBadgeUnlockedNow(cfg, stats) {
            if (cfg.id === 'getting-started') {
                return stats.totalTasks > 0;
            }
            if (cfg.id === 'task-finisher') {
                return stats.completedTasks >= 10;
            }
            if (cfg.id === 'consistency') {
                return stats.focusStreak >= 3;
            }
            return false;
        }

        function renderBadges(state) {
            const container = document.getElementById('badge-container');
            if (!container) return;

            const html = BADGES_CONFIG.map(cfg => {
                const unlocked = !!state.badges?.[cfg.id];
                const statusClass = unlocked ? 'badge-unlocked' : 'badge-locked';
                const statusText = unlocked ? (cfg.unlockedText || 'Unlocked') : (cfg.lockedText || 'Locked');
                const lockIcon = unlocked ? '' : 'üîí';
                return `
                    <div class="badge-card ${statusClass}">
                        <div class="badge-card-header">
                            <div class="badge-icon">${cfg.icon}</div>
                            <span class="badge-lock" aria-hidden="true">${lockIcon}</span>
                        </div>
                        <div class="badge-title">${cfg.title}</div>
                        <p class="badge-description">${cfg.description}</p>
                        <p class="badge-status">${statusText}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function updateBadgesFromStats(taskCount, completedCount, focusStreak) {
            let state = loadBadgesState();
            if (!state.badges) state.badges = {};

            const stats = {
                totalTasks: taskCount,
                completedTasks: completedCount,
                focusStreak: focusStreak || 0,
            };

            BADGES_CONFIG.forEach(cfg => {
                const alreadyUnlocked = !!state.badges[cfg.id];
                const shouldUnlock = computeBadgeUnlockedNow(cfg, stats);
                if (shouldUnlock && !alreadyUnlocked) {
                    state.badges[cfg.id] = { unlockedAt: new Date().toISOString() };
                }
            });

            saveBadgesState(state);
            renderBadges(state);
        }

        // Load user profile and statistics
        async function loadProfile() {
            try {
                // Get user info
                const userRes = await window.TimeNestAuth.me();
                if (!userRes.ok) {
                    window.location.href = './login.html';
                    return;
                }

                const email = userRes.data.user.email;
                const name = email.split('@')[0];

                document.getElementById('profile-name').textContent = name.charAt(0).toUpperCase() + name.slice(1);
                document.getElementById('profile-email').textContent = email;
                document.getElementById('profile-avatar').textContent = email.charAt(0).toUpperCase();

                // Load saved avatar if exists
                const savedAvatar = localStorage.getItem('profile-avatar-' + email);
                if (savedAvatar) {
                    const avatarDisplay = document.getElementById('profile-avatar-display');
                    avatarDisplay.innerHTML = `<img src="${savedAvatar}" alt="Profile Picture">`;
                }

                // Fetch tasks from API
                const tasksRes = await fetch('/api/tasks/', {
                    headers: { 'Authorization': `Bearer ${window.TimeNestAuth.getToken()}` }
                });

                if (tasksRes.ok) {
                    const body = await tasksRes.json();
                    const tasks = body.items || [];
                    const completed = tasks.filter(t => t.completed).length;
                    const pending = tasks.filter(t => !t.completed).length;
                    const rate = tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0;

                    document.getElementById('stat-tasks').textContent = tasks.length;
                    document.getElementById('stat-completed').textContent = completed;
                    document.getElementById('stat-pending').textContent = pending;
                    document.getElementById('stat-rate').textContent = rate + '%';

                    // Simple productivity score [0-100]
                    const score = Math.min(100, rate + Math.min(completed * 5, 40));
                    document.getElementById('stat-score').textContent = score;

                    // Display history
                    displayHistory(tasks);

                    // Focus stats based on local focus history
                    const focusState = loadFocusState();
                    const streak = getStreakDays(focusState);
                    const weeklyHours = getWeeklyFocusHours(focusState);
                    document.getElementById('stat-streak').textContent = `${streak} day${streak === 1 ? '' : 's'}`;
                    document.getElementById('stat-weekly-focus').textContent = `${weeklyHours.toFixed(1)}h`;

                    // Update badges based on tasks and focus
                    updateBadgesFromStats(tasks.length, completed, streak);
                }

                
            } catch (err) {
                console.error('Error loading profile:', err);
            }
        }

        // Handle avatar upload
        const avatarInput = document.getElementById('avatar-input');
        avatarInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const imageData = event.target.result;
                    const avatarDisplay = document.getElementById('profile-avatar-display');
                    avatarDisplay.innerHTML = `<img src="${imageData}" alt="Profile Picture">`;
                    
                    // Save to localStorage
                    const userRes = await window.TimeNestAuth.me();
                    if (userRes.ok) {
                        const email = userRes.data.user.email;
                        localStorage.setItem('profile-avatar-' + email, imageData);
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // Edit Profile functionality
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const editProfileSection = document.getElementById('edit-profile-section');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editProfileForm = document.getElementById('edit-profile-form');

        editProfileBtn.addEventListener('click', async () => {
            editProfileSection.classList.toggle('active');
            editProfileSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Pre-fill form with current data
            const userRes = await window.TimeNestAuth.me();
            if (userRes.ok) {
                const email = userRes.data.user.email;
                document.getElementById('edit-email').value = email;
                
                const savedName = localStorage.getItem('profile-name-' + email);
                if (savedName) {
                    document.getElementById('edit-name').value = savedName;
                } else {
                    document.getElementById('edit-name').value = email.split('@')[0];
                }
                
                const savedProfile = JSON.parse(localStorage.getItem('timenest_profile_' + email) || '{}');
                if (savedProfile.username) document.getElementById('edit-username').value = savedProfile.username;
                if (savedProfile.goalMinutes) document.getElementById('edit-goal').value = savedProfile.goalMinutes;
                if (savedProfile.workType) document.getElementById('edit-work-type').value = savedProfile.workType;
                if (savedProfile.focusMethod) document.getElementById('edit-focus-method').value = savedProfile.focusMethod;
            }
        });

        cancelEditBtn.addEventListener('click', () => {
            editProfileSection.classList.remove('active');
        });

        editProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userRes = await window.TimeNestAuth.me();
            if (!userRes.ok) return;
            
            const email = userRes.data.user.email;
            const newName = document.getElementById('edit-name').value;
            const username = document.getElementById('edit-username').value;
            const goalMinutes = parseInt(document.getElementById('edit-goal').value || '0', 10) || 0;
            const workType = document.getElementById('edit-work-type').value;
            const focusMethod = document.getElementById('edit-focus-method').value;
            
            // Save to localStorage
            localStorage.setItem('profile-name-' + email, newName);
            const profileKey = 'timenest_profile_' + email;
            const existing = JSON.parse(localStorage.getItem(profileKey) || '{}');
            const updated = {
                ...existing,
                fullName: newName,
                username,
                goalMinutes,
                workType,
                focusMethod,
            };
            localStorage.setItem(profileKey, JSON.stringify(updated));
            
            // Update display
            document.getElementById('profile-name').textContent = newName;
            
            // Hide edit section
            editProfileSection.classList.remove('active');
            
            alert('Profile updated successfully!');
        });

        // Load saved profile data
        async function loadSavedProfile() {
            const userRes = await window.TimeNestAuth.me();
            if (userRes.ok) {
                const email = userRes.data.user.email;
                
                // Load saved name
                const savedName = localStorage.getItem('profile-name-' + email);
                if (savedName) {
                    document.getElementById('profile-name').textContent = savedName;
                }
                const savedProfile = JSON.parse(localStorage.getItem('timenest_profile_' + email) || '{}');
                if (savedProfile.username) {
                    document.getElementById('edit-username').value = savedProfile.username;
                }
                if (savedProfile.goalMinutes) {
                    document.getElementById('edit-goal').value = savedProfile.goalMinutes;
                }
            }
        }

        function displayHistory(tasks) {
            const container = document.getElementById('history-container');

            if (tasks.length === 0) {
                container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üìã</div>
              <p>No work history yet. Start by creating tasks or habits!</p>
            </div>
          `;
                return;
            }

            // Sort by date, most recent first
            const sorted = tasks.sort((a, b) => new Date(b.updated_at || b.created_at || 0) - new Date(a.updated_at || a.created_at || 0));

            container.innerHTML = sorted.map(task => {
                const date = task.updated_at || task.created_at ? new Date(task.updated_at || task.created_at).toLocaleDateString() : 'N/A';
                const statusBadge = task.completed
                    ? '<span class="history-badge badge-completed">‚úì Completed</span>'
                    : '<span class="history-badge badge-pending">‚è≥ Pending</span>';

                return `
            <div class="history-item">
              <div class="history-left">
                <div class="history-title">${task.title || 'Untitled Task'}</div>
                <div class="history-meta">Created: ${date}</div>
              </div>
              <div>${statusBadge}</div>
            </div>
          `;
            }).join('');
        }

        function initReminderSettings() {
            const api = window.TimeNestReminders;
            if (!api) return;

            const voiceToggle = document.getElementById('reminder-voice-toggle');
            const notifToggle = document.getElementById('reminder-notification-toggle');
            const statusEl = document.getElementById('reminder-status');
            const testBtn = document.getElementById('reminder-test-btn');

            function renderStatus() {
                const status = api.getStatus();
                if (voiceToggle) voiceToggle.checked = !!status.voiceEnabled;
                if (notifToggle) notifToggle.checked = status.notificationsEnabled !== false;

                if (!statusEl) return;
                let parts = [];
                const blocked = status.notificationsSupported && status.permission === 'denied';

                if (!status.notificationsSupported) {
                    parts.push('Notifications: Not supported in this browser.');
                } else if (blocked) {
                    parts.push('Notifications: Blocked in browser settings.');
                } else if (status.permission === 'granted' && status.notificationsEnabled !== false) {
                    parts.push('Notifications: Allowed.');
                } else if (status.permission === 'granted' && status.notificationsEnabled === false) {
                    parts.push('Notifications: Disabled in TimeNest.');
                } else {
                    parts.push('Notifications: Waiting for browser permission.');
                }
                if (status.voiceSupported) {
                    parts.push(`Voice reminders: ${status.voiceEnabled ? 'On' : 'Off'}.`);
                } else {
                    parts.push('Voice reminders: Not supported in this browser.');
                }
                if (voiceToggle) {
                    voiceToggle.disabled = !!blocked;
                }
                statusEl.textContent = parts.join(' ');
            }

            if (voiceToggle) {
                voiceToggle.addEventListener('change', (e) => {
                    api.toggleVoiceReminders(e.target.checked);
                    renderStatus();
                });
            }

            if (notifToggle) {
                notifToggle.addEventListener('change', (e) => {
                    api.toggleNotifications(e.target.checked);
                    renderStatus();
                });
            }

            if (testBtn) {
                testBtn.addEventListener('click', async () => {
                    await api.testNotification();
                    renderStatus();
                });
            }

            renderStatus();
        }

        loadProfile();
        loadSavedProfile();
        initReminderSettings();
    </script>
</body>

</html>